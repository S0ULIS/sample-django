<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel= "stylesheet" href= "/static/docs/css/header.css">
		<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
		<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
		<script src="/static/docs/js/utils/include.js"></script>
	</head>
	<body style="background-color: #FEFAE0;">
		<div class="row justify-content-center">
			<div class="col-md-9">
				<div class="row mt-5"><div id="headerContainer"></div></div>
				<div class="container bg-image">
					<div class="card border-success mb-5 mt-4" style="background-color:  #FEFAE0;">
						<div class="row justify-content-between m-2">
							<div class="col-md-4">
								<button class="btn btn-success" onclick="iniciarEscaner(); document.getElementById('vidContainer').style.display = 'block'">Iniciar Escaner</button>
								<button class="btn btn-success" onclick="scanner.stop(); document.getElementById('vidContainer').style.display = 'none'">Parar Escaner</button>	
							</div>
							<form id="sevienelaferia" class="col-md-3 float-right" action = "" method="post">
								{% csrf_token %}
								<div class="input-group">
									<input type="text" id="id_socio" name="socio" class="form-control" placeholder="CheckIn/CheckOut" aria-label="Recipient's username" aria-describedby="button-addon2">
									<button class="btn btn-success" type="button" id="socioSubmit"><i class="fa fa-search" aria-hidden="true"></i></button>
									<button id="submit_id" type="submit" style="display: none;"></button>
								</div>
							</form>
						</div>
					</div>
					<div class="row mt-3 mb-5 justify-elements-md-center">
						<div class="col-md-8" id="vidContainer">
							<video id="preview"></video>
						</div>
					</div>
		
					<div class="card mb-5">
						<div class="card-header bg-success border-success text-white">
							<div class="row justify-content-between">
								<div class="col">
									<h5>En el club</h5>
								</div>
								<div class="col">
									<h5 style="float: right;">Aforo: {{aforo}}</h5>
								</div>
							</div>
						</div>
						<div class="card-body">
							<div style="overflow-y: scroll; height: 600px;">
								<ul class="list-group list-group-flush">
								{% for data in dataset %}
								{% if data.dentro %}
									{% if data.estado == "Renovado" %}
										<li class="list-group-item justify-elements-md-center align-text-center border-success border border-3 rounded-3 mb-2">
										
									{% elif data.estado == "No Renovado" %}
										<li class="list-group-item justify-elements-md-center align-text-center border-danger border border-3 rounded-3 mb-2">
									{% elif data.estado == "Expulsado" %}
										<li class="list-group-item justify-elements-md-center align-text-center bg-dark rounded-3 mb-2">
									{% else %}
										<li class="list-group-item justify-elements-md-center align-text-center border-warning border border-3 rounded-3 mb-2">
									{% endif %}
											<a target="_blank" class="align-middle" href="/admin/socios/socio/{{data.socioId}}/change/">{{data.numeroSocio}}</a> {{data.nombre}} {{data.apellidos}}
											<img class="fotoPerfil float-end" width="30%" src="/media/{{data.fotoPerfil}}" alt="fotoPerfil">
										</li>
								{% endif %}
								{% endfor %} 
								</ul>
							</div>		
						</div>
					</div>
				</div>
			</div>

		</div>	
		<div class="fixed-top bg-dark d-none" id="confirm-box">
			<div class="row text-center">
				<div class="col-md">
					<h1 class="text-white">Entrada de Socio:</h3>
				</div>
				
			</div>
			<div class="row justify-content-md-center mt-5">
				<div class="col-md-9">
					<ul class="list-group">
						<li class="list-group-item justify-elements-md-center align-text-center bg-dark border-light border border-2 rounded-3 mb-2 mr-3" style="background-color: #FEFAE0;" >
							<a id="enlacePreg" target="_blank" class="align-middle mt-5" target="_blank" href=""></a>
							<img id="imgPreg" class="fotoPerfil float-end mt-3 mr-5" width="30%" src="" alt="fotoPerfil">
						</li>
					</ul>
				</div>
			</div>
			<div class="row text-center mb-3 mt-2">
				<div class="col-md ">
					<button class="btn-primary btn" id="pregSi">Aceptar</button>
					<button class="btn-primary btn" id="pregNo">Cancelar</button>
				</div>
			</div>
			
		</div>
		<style>
			.container{
				/*background-image: url("https://cdn.pixabay.com/photo/2016/03/15/02/42/floor-1256804_960_720.jpg");*/
				background-position: center;
					background-repeat: repeat;
					background-size: cover;
			}
			div {
				background-color: transparent;
			}
		</style>
		
		<script type="text/javascript">
			let clicked = false;
			$("#sevienelaferia").submit( (event) => {
				if (! clicked) {
					event.preventDefault();
					$("#socioSubmit").click();
				}
			});
			$("#socioSubmit").click(function(event){
				clicked = true;
				identifySocio(parseInt(document.getElementById("id_socio").value));
			});
	
			let scanner = null;
			function iniciarEscaner(){
			scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
			scanner.addListener('scan', function (content) {
				let message = atob(content);
				if(isNaN(message)){
					alert("qr Incorrecto");
				}else{
				let num = (parseInt(message)-777)/1031;
				identifySocio(num);
				
				}});
	
				Instascan.Camera.getCameras().then(function (cameras) {
				if (cameras.length > 1) {
				scanner.start(cameras[0]);
				}else if (cameras.length > 0){
				scanner.start(cameras[0]);
				}else {
				console.log('No cameras found.');
				}
			}).catch(function (e) {
				console.log(e);
			});
				
			}
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}
	
				function identifySocio(num){
					const csrftoken = getCookie('csrftoken')
	
					$.ajax({
						url : `/getSocio/?nSocio=${num}`, // the endpoint
						type : "GET", // http method
						headers : {
							'X-CSRFToken': csrftoken
						},
	
						success : function(data) {
							let socio = JSON.parse(data)[0].fields;
							if (!socio.dentro){
								$("#confirm-box").removeClass("d-none");
								$("#imgPreg").attr("src", "/media/"+socio.fotoPerfil);
								document.getElementById("enlacePreg").innerHTML = socio.numeroSocio+" "+socio.nombre+ " "+ socio.apellidos;
								let url = "/admin/socios/socio/"+socio.socioId+"/change/";
								document.getElementById("enlacePreg").href=url;
								$("#pregSi").click(function () {
									document.getElementById("id_socio").value = socio.numeroSocio;
									$("#sevienelaferia").submit();
								});
								$("#pregNo").click(function () {
									$("#confirm-box").addClass("d-none");
								});
							}else{
								document.getElementById("id_socio").value = socio.numeroSocio;
								$("#sevienelaferia").submit();
							}
						}
	
					});
				}
			</script>
			<script>
				 include("/static/docs/header.html", "#headerContainer");
			</script>
	</body>
</html>
